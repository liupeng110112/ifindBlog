---
layout: post
title: 收藏颜色
category : python_django
tagline: "Supporting tagline"
tags : [python, django]
---
{% include JB/setup %}
# 收藏颜色的工具
---
iFinD与FIS的结合
=

----------
看过FIS的相关介绍初步使用后，觉得很强大而且很实用，只需要通过一些简单配置即可完成资源压缩，合并，自动替换路径等相关功能，各种工具都集成到了FIS中，FIS目前版本升级到FIS3，感觉更加友好，而且提供了多种状态的概念（media）,一份代码可以部署到不同的环境中。


跟着文档跑着demo，通过简单的配置（具体代码参考官方文档[http://fis.baidu.com/fis3/docs/beginning/intro.html](http://fis.baidu.com/fis3/docs/beginning/intro.html)）：

    fis.match('*.js', {
	   fis-optimizer-uglify-js 插件进行压缩，已内置
		  optimizer: fis.plugin('uglify-js')
		});
	
	fis.match('*.css', {
	  // fis-optimizer-clean-css 插件进行压缩，已内置
	  //optimizer: fis.plugin('clean-css')
	});
	.....
	以下省略
<!--break-->
css、js、图片以及图片合并都变得如此简单，这时迫不及待的想用到iFinD项目中去。好，说做就做。

打开iFinD项目看着如此复杂多的目录有点傻眼了，一时半会不知从哪开始下手。初步从js模块统计就有70来个，而且目录里包含了很多其他文件，那就从最迫切需要改进并且重要的模块做起。想都不要想最重要的模块就是首页了，决定就从首页开始实践。

问题来了 我该如何下手呢？我怎样才能和官方文档中的demo一样敲个命令就能得到自己想要的结果。理想是美好的，现实是残酷的。目前我们项目中的目录结构想要和官方demo的结构有很大出入，这时就需要做些工作来符合FIS的目录结构（构建时能通过路径找到相关资源）。

目前将css,js,tpl资源进行构建（这里暂时先不对图片做处理），编写了一个``复制文件并替换tpl中的资源路径``的功能来达到FIS的目录结构。基础的目录结构如下：

	fis
	 |
	 |---css
	 |---js
	 |---tpl	
	 |---config.json
	 |---fis-conf.js

其中

1. fis是自己定的目录 可以为任意位置 用来存储复制过来的资源
2. css js tpl 分别是存储指定模块的css、js、tpl
3. config.json用来配置从iFinD目录中复制的参数
4. fis-conf.js是FIS用来配置构建的文件


这里config.json和fis-conf.js需要手动配置 其他的自动生成。

config.json配置参数说明如下：

	cssPath: css源路径
	jsPath: js源路径
	tplPath: tpl源路径
	destDir: 需要复制文件到指定的目录
	exculdeJs: 不需要复制的js文件
	exculdecss: 不需要复制的css文件

以上配置皆是字符串 暂不支持数组（后续会提供支持）

以上工作需要fis-command-copy模块的支持源码已经上传到github上去了 地址：[https://github.com/liupeng110112/FED-share/blob/master/fis-command-copy](https://github.com/liupeng110112/FED-share/blob/master/fis-command-copy)

这个模块主要做了2件事：
	
	1. 复制文件到指定的目录
	2. 替换tpl的资源引用路径


	
完成了以上的工作准备工作才算做好，可以歇息一会 ^-^ 


接下来只需要配置下fis-conf.js来完成相关的构建即可 关于用法这里不细说：

	// 开发阶段
	fis.match(/\/js\/(.*\.js$)/i, {
	  optimizer: fis.plugin('uglify-js'),
	  url: '/thsft/static/index/js/$1',
	  useHash: true,
	  deploy: fis.plugin('local-deliver',{ 
	    to : 'E:/svn/jgbphp/server/www/static/index'
	  })
	})
	fis.match(/\/css\/(.*\.css$)/i, {
	  optimizer: fis.plugin('clean-css'),
	  url: '/thsft/static/index/css/$1',
	  useHash: true,
	  deploy: fis.plugin('local-deliver',{ 
	    to : 'E:/svn/jgbphp/server/www/static/index'
	  })
	})
	fis.match(/\/tpl\/(.*\.tpl$)/i,{
	  release: './$1',
	  deploy: fis.plugin('local-deliver',{ 
	    to : 'E:/svn/jgbphp/server/Zend/application/modules/index/views/scripts/index/'
	  })
	})
	
	// 发布阶段
	fis.media('prod').match(/\/js\/(.*\.js$)/i,{
	  deploy: fis.plugin('local-deliver',{ 
	    to : 'E:/svn/jgbphp/branches/ifind_server/thsft/www/static/index'
	  })
	})
	fis.media('prod').match(/\/css\/(.*\.css$)/i,{
	  deploy: fis.plugin('local-deliver',{ 
	    to : 'E:/svn/jgbphp/branches/ifind_server/thsft/www/static/index'
	  })
	})
	fis.media('prod').match(/\/tpl\/(.*\.tpl$)/i,{
	  deploy: fis.plugin('local-deliver',{ 
	    to : 'E:/svn/jgbphp/branches/ifind_server/thsft/Zend/application/modules/index/views/scripts/index'
	  })
	})

``注意：开发时使用命令fis3 release 来进行构建 发布时使用fis3 release prod来进行部署``


##小结
目前只对首页进行的最基本的优化：压缩以及md5.由于项目的复杂与历史悠久问题，诸多问题不能很好去操作，比如js是否能合并，图片是否能去合并，故只对首页相关的做基本的处理

整个过程的思路是以内网开发机器上的代码为源代码，本地代码为构建的源代码（这里特别需要注意的是js、css可以发布到新的目录，而tpl由于控制器的原因只能被构建后的代码覆盖），这其中还有需要很多缺陷去改善，一步一步的去完善



	


